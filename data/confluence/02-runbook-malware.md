# Runbook: Malware Detection and Containment

| Field          | Value                                         |
|----------------|-----------------------------------------------|
| **Document ID**   | SOC-RB-002                                 |
| **Title**         | Malware Detection and Containment Runbook  |
| **Author**        | Raj Patel                                  |
| **Last Updated**  | 2025-10-28                                 |
| **Status**        | Active                                     |
| **Review Cycle**  | Quarterly                                  |
| **Classification**| Internal — Meridian National Bank           |

---

## 1. Purpose

This runbook provides Meridian SOC analysts with procedures for detecting, containing, investigating, and remediating malware infections across the Meridian National Bank corporate network and endpoint fleet. This includes commodity malware, ransomware, remote access trojans (RATs), and fileless malware.

## 2. Scope

This procedure covers malware events originating from:
- **CrowdStrike Falcon** endpoint detection alerts
- **Splunk** correlation rules (`SOC-CORR-MAL-001` through `SOC-CORR-MAL-022`)
- **Palo Alto Networks** IDS/IPS alerts for known C2 traffic
- **Proofpoint TAP** alerts for email-delivered malware payloads
- Manual analyst discovery during threat hunting

## 3. Severity Classification

| Scenario | Severity | SLA Response |
|----------|----------|--------------|
| Blocked malware attempt (no execution) | P4 | 4 hours |
| Single endpoint infection, commodity malware | P3 | 2 hours |
| Multiple endpoints infected or lateral movement detected | P2 | 30 minutes |
| Ransomware execution or data exfiltration confirmed | P1 | 15 minutes |
| Malware on critical banking infrastructure (SWIFT, core banking) | P1 | 15 minutes |

> **See:** [Escalation Procedure (SOC-PROC-003)](03-escalation-procedure.md) for full severity definitions and notification requirements.

## 4. Required Tools and Access

| Tool | Purpose | Access Request |
|------|---------|---------------|
| CrowdStrike Falcon | EDR — detection, isolation, forensic collection | ServiceNow `Access > CrowdStrike` |
| Splunk | Log correlation, network traffic analysis | Auto-provisioned for SOC analysts |
| Palo Alto Panorama | Firewall and IPS management | ServiceNow `Access > Network Security` |
| VirusTotal Enterprise | Malware sample analysis | Shared API key in CyberArk vault `SOC-VT-API` |
| Any.Run / Joe Sandbox | Dynamic malware analysis (sandbox) | Shared credentials in CyberArk vault `SOC-Sandbox` |
| ServiceNow | Incident ticketing | Auto-provisioned |

## 5. Detection and Triage

### 5.1 CrowdStrike Alert Triage

1. Open the alert in **CrowdStrike Falcon > Activity > Detections**.
2. Review the detection details:
   - **Tactic and Technique** (MITRE ATT&CK mapping)
   - **Process tree** — identify the parent process chain
   - **File details** — hash, file path, file name, signature status
   - **Network connections** — any outbound C2 communication
   - **Severity score** — CrowdStrike's own severity rating

3. Determine if the detection is a true positive:
   - Check the file hash against VirusTotal
   - Review the process tree for suspicious parent-child relationships
   - Check if the endpoint is a developer workstation (higher FP rate for build tools)

> **See:** [Knowledge Base: False Positives (SOC-KB-008)](08-knowledge-base-false-positives.md) — Section 3 covers common CrowdStrike false positives including developer tools, IT admin scripts, and legitimate pentest activity.

### 5.2 Splunk Queries for Malware Investigation

Search for process execution events matching a known malicious hash:

```spl
index=endpoint sourcetype=crowdstrike:events
| search event_type="ProcessRollup2" SHA256HashData="<HASH>"
| table _time, ComputerName, UserName, FileName, FilePath, CommandLine, ParentBaseFileName
| sort _time
```

Identify potential lateral movement from an infected host:

```spl
index=network sourcetype=pan:traffic
| search src_ip="<INFECTED_HOST_IP>"
| where dest_port IN (445, 135, 3389, 5985, 5986)
| stats count by dest_ip, dest_port, app
| where count > 3
| sort -count
```

Search for DNS queries to known C2 domains:

```spl
index=dns sourcetype=stream:dns
| search query_type=A
| lookup threat_intel_domains domain AS query OUTPUT threat_category, confidence
| where isnotnull(threat_category)
| table _time, src_ip, query, threat_category, confidence
| sort -_time
```

Check for persistence mechanisms created on a host:

```spl
index=endpoint sourcetype=crowdstrike:events
| search ComputerName="<HOSTNAME>" event_type IN ("RegValueSet", "ScheduledTaskRegistered", "ServiceInstalled")
| table _time, event_type, RegObjectName, TaskName, ServiceName, CommandLine
| sort _time
```

> **See:** [Tool Guide: Splunk (SOC-TG-004)](04-tool-guide-splunk.md) for the complete malware investigation query library.

## 6. Containment Procedure

### 6.1 Host Isolation

**Immediately isolate the infected host** to prevent lateral movement:

1. **CrowdStrike Falcon**: Navigate to **Hosts > [hostname]** → Click **Contain Host**
   - This blocks all network traffic except CrowdStrike cloud communication
   - The host remains manageable via Falcon RTR (Real Time Response)

2. If CrowdStrike isolation is not possible (agent offline):
   - Contact Network Operations to disable the switch port
   - If the host is on VPN (10.200.0.0/16), revoke the VPN certificate via Cisco ISE

3. If the host is in AWS (10.50.0.0/16):
   - Apply the quarantine security group `sg-0a1b2c3d4e5f67890`:

```bash
aws ec2 modify-instance-attribute \
  --instance-id <INSTANCE_ID> \
  --groups sg-0a1b2c3d4e5f67890 \
  --region us-east-1 \
  --profile meridian-security
```

> **See:** [Tool Guide: AWS Security (SOC-TG-005)](05-tool-guide-aws-security.md) for additional AWS containment procedures.

### 6.2 Account Containment

If the malware was running under a user context:

1. Disable the user account in Active Directory
2. Revoke all active sessions (Azure AD + on-prem)
3. Reset the user's password
4. Check for suspicious activity from the account in the last 72 hours:

```spl
index=auth sourcetype=windows:security user="<USERNAME>"
| search EventCode IN (4624, 4625, 4648, 4672, 4720, 4732)
| stats count by EventCode, src_ip, dest, LogonType
| sort -count
```

### 6.3 Network Containment

Block identified C2 infrastructure:

1. **Palo Alto Firewall**: Add C2 IPs/domains to the `SOC-Block-IOC` EDL (External Dynamic List)
   - File location: `sftp://10.128.5.20:/feeds/soc-block-ioc.txt`
   - One IOC per line, commit propagates within 5 minutes

2. **DNS Sinkhole**: Add C2 domains to the Infoblox RPZ feed
   - ServiceNow request: `Network > DNS > RPZ Update`

## 7. Evidence Collection

### 7.1 CrowdStrike Real Time Response (RTR)

Connect to the isolated host via Falcon RTR for forensic data collection:

```
# Collect running processes
runscript -CloudFile="Get-ProcessList" -CommandLine=""

# Collect network connections
runscript -CloudFile="Get-NetworkConnections" -CommandLine=""

# Collect scheduled tasks
runscript -CloudFile="Get-ScheduledTasks" -CommandLine=""

# Collect recent file modifications in user profile
runscript -CloudFile="Get-RecentFiles" -CommandLine="-Path C:\Users -Hours 24"

# Collect memory dump (P1 incidents only — requires Tier 3 approval)
memdump
```

### 7.2 Malware Sample Collection

1. Obtain the malware sample hash from CrowdStrike.
2. Download the sample from CrowdStrike Falcon X or the quarantine store.
3. Upload to **Any.Run** or **Joe Sandbox** for dynamic analysis:
   - Use the `Meridian-SOC` workspace
   - Set environment to match the victim OS version
   - Record the analysis URL in the ServiceNow ticket

### 7.3 Log Preservation

For P1 and P2 incidents, ensure log preservation:

```spl
| savedsearch "SOC-LogPreserve-Endpoint" host="<HOSTNAME>" earliest=-7d latest=now
```

Contact the Splunk admin team to extend retention for relevant indexes if the investigation will exceed 90 days.

## 8. Remediation

### 8.1 Endpoint Remediation

For commodity malware with limited impact:

1. Run a full CrowdStrike scan on the endpoint
2. Remove identified malicious files via RTR
3. Remove persistence mechanisms (registry keys, scheduled tasks, services)
4. Un-isolate the host once clean
5. Monitor for 48 hours post-remediation

For ransomware or advanced malware:

1. **Do not un-isolate.** The host must be reimaged.
2. Coordinate with Desktop Engineering for reimage.
3. Restore user data from last known good backup (confirm backup date is before infection).
4. Ensure the reimaged host has current CrowdStrike sensor before reconnecting to network.

### 8.2 Scope Assessment

Before declaring the incident resolved, verify:

- [ ] No other endpoints show the same IOCs
- [ ] No lateral movement detected in network logs
- [ ] No persistence mechanisms remain on any host
- [ ] No data exfiltration detected
- [ ] All compromised credentials have been reset
- [ ] C2 infrastructure is blocked at perimeter

## 9. Escalation Triggers

Escalate immediately to **P1** if any of the following occur:

- Ransomware note is displayed or files are encrypted
- Malware is detected on servers in the DMZ (172.20.0.0/24)
- Malware is found on SWIFT terminals or core banking systems
- Data exfiltration is confirmed (outbound data > 100MB to unknown destination)
- Multiple endpoints (>5) show signs of infection
- The malware is associated with a known APT group

> **See:** [Escalation Procedure (SOC-PROC-003)](03-escalation-procedure.md) — Section 4 covers CISO notification and regulatory reporting requirements for malware incidents.

## 10. Post-Incident Actions

1. Complete the ServiceNow ticket with full timeline and IOC list.
2. Submit all IOCs to the threat intelligence team.
3. Request detection rule updates if a gap was identified.

> **See:** [Detection Rule Change Process (SOC-PROC-007)](07-process-detection-rule-changes.md)

4. For P1 and P2 incidents, schedule a Post-Incident Review within 5 business days.

> **See:** [Post-Incident Review Template (SOC-PIR-010)](10-post-incident-review-example.md) for the PIR format.

5. Update this runbook if new TTPs were observed.

## 11. Reference: Common Malware Categories

| Category | Examples | Typical Delivery | Key Indicators |
|----------|----------|-------------------|----------------|
| Ransomware | LockBit, BlackCat, Royal | Phishing, RDP brute force | File encryption, ransom note, shadow copy deletion |
| RAT | Cobalt Strike, AsyncRAT | Phishing, drive-by download | Beaconing to C2, process injection |
| Infostealer | Raccoon, RedLine, Vidar | Phishing, malvertising | Browser credential access, crypto wallet access |
| Banking Trojan | Emotet, QakBot, IcedID | Phishing (macro docs) | Credential hooking, web injection |
| Loader/Dropper | BatLoader, Gootloader | SEO poisoning, malvertising | Downloads secondary payloads |

---

*Document maintained by the Meridian Cyber Defense Center. For questions, contact Raj Patel (raj.patel@meridianbank.com) or post in Slack #soc-general.*
